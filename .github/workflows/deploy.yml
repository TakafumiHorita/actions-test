name: Deploy via rsync over SSH (no build)

on:
  push:
    branches:
      # mainブランチにプッシュされたときにトリガーされる
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest # GitHubが用意したUbuntuの最新環境でジョブを実行

    steps:
      - name: Checkout code
        uses: actions/checkout@v3 # リポジトリのコードをチェックアウト（取得）

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3 # SSHエージェントを起動し、秘密鍵を使えるようにする
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }} # GitHub Secretsに登録したSSH秘密鍵を使用

      - name: Add SSH host key
        run: |
          mkdir -p ~/.ssh  # SSH設定フォルダを作成（すでにあってもOK）
          ssh-keyscan -H ${{ secrets.SAKURA_SSH_HOST }} >> ~/.ssh/known_hosts  # 接続先サーバーのホスト鍵を登録（警告回避のため）

      - name: Deploy with rsync
        run: |
          rsync -avz --delete \
            --exclude=".git/" \
            --exclude=".github/" \
            --exclude=".DS_Store" \
            --exclude="README.md" \
            --exclude=".htaccess" \
            --exclude=".htpasswd" \
            ./ ${{ secrets.SAKURA_SSH_USER }}@${{ secrets.SAKURA_SSH_HOST }}:${{ vars.SAKURA_DEPLOY_PATH }}
